function [qamSyms,bits] = qamDeModu(qamSig,modFormat)
% Description:
%     QAMDEMODU Generate dec signal: qam --> dec
% 
% EXAMPLE:
%     [qamSyms,bits] = qamDeModu(qamSig,modFormat)
%     
% INPUT:
%     bits         - Input prbs signal
%     modFormat    - Modulation format
%     
% OUTPUT:
%     qamSig       - Modulated qam signal
%     
% Modifications:
% Version    Date        Author        Log.
% V1.0       20151024    H.B. Zhang    Create this script
% V1.1       20160824    H.B. Zhang    Add NRZ format
% V1.2       20170702    H.B. Zhang    Add 16/32/64/128QAM
% Ref:
%     

if isempty(qamSig)
    qamSyms = [];
    bits    = [];
    return;
end
if iscell(modFormat)
    modFormat = char(modFormat);
end

qamSig         = qamSig(:);
symInputLen    = length(qamSig);
qamSyms        = zeros(symInputLen,1);
nBpB           = format2nBpB(modFormat);

modFormat = upper(modFormat);
switch modFormat
    case {'BPSK','NRZ'}
        cnstPattern  = [-1;1];
    case {'DBPSK'}
        cnstPattern  = [1;-1];
    case {'DQPSK'}
        cnstPattern  = [1i*1;1;-1;-1i*1];
    case {'QPSK'}
        cnstPattern  = [1i*1;-1;1;-1i*1];
    case '4QAM'
        cnstPattern  = [-1+1i*1;-1-1i*1;1+1i*1;1-1i*1];
    case 'PAM4'
        cnstPattern  = [-3;-1;1;3];
    case '16QAM'
        cnstPattern = [-3+1i*3;-3+1i*1;-3-1i*1;-3-1i*3;...
                        -1+1i*3;-1+1i*1;-1-1i*1;-1-1i*3;...
                         1+1i*3; 1+1i*1; 1-1i*1; 1-1i*3;...
                         3+1i*3; 3+1i*1; 3-1i*1; 3-1i*3;];
    case '32QAM'
        cnstPattern = [ -3-5j -1-5j -3+5j -1+5j -5-3j -5-1j -5+3j -5+1j ...
                        -1-3j -1-1j -1+3j -1+1j -3-3j -3-1j -3+3j -3+1j ...
                         3-5j  1-5j  3+5j  1+5j  5-3j  5-1j  5+3j  5+1j ...
                         1-3j  1-1j  1+3j  1+1j  3-3j  3-1j  3+3j  3+1j]; %  a + bj : [a0 a1 a2 b0 b1]
    case '64QAM'
        cnstPattern = [   3+3j  3+1j  1+3j  1+1j  3+5j  3+7j  1+5j  1+7j ...
                          5+3j  5+1j  7+3j  7+1j  5+5j  5+7j  7+5j  7+7j ...
                          3-3j  3-1j  1-3j  1-1j  3-5j  3-7j  1-5j  1-7j ...
                          5-3j  5-1j  7-3j  7-1j  5-5j  5-7j  7-5j  7-7j ...
                         -3+3j -3+1j -1+3j -1+1j -3+5j -3+7j -1+5j -1+7j ...
                         -5+3j -5+1j -7+3j -7+1j -5+5j -5+7j -7+5j -7+7j ...
                         -3-3j -3-1j -1-3j -1-1j -3-5j -3-7j -1-5j -1-7j ...
                         -5-3j -5-1j -7-3j -7-1j -5-5j -5-7j -7-5j -7-7j];    %  a + bj : [a0 a1 a2 b0 b1 b2]
    case '128QAM'
        cnstPattern = [ -7-7j  -7-5j  -7-1j  -7-3j  -7+7j   -7+5j   -7+1j   -7+3j ...  
                        -5-7j  -5-5j  -5-1j  -5-3j  -5+7j   -5+5j   -5+1j   -5+3j ...  
                        -1-7j  -1-5j  -1-1j  -1-3j  -1+7j   -1+5j   -1+1j   -1+3j  ... 
                        -3-7j  -3-5j  -3-1j  -3-3j  -3+7j   -3+5j   -3+1j   -3+3j  ... 
                         7-7j   7-5j   7-1j   7-3j   7+7j    7+5j    7+1j    7+3j  ... 
                         5-7j   5-5j   5-1j   5-3j   5+7j    5+5j    5+1j    5+3j  ... 
                         1-7j   1-5j   1-1j   1-3j   1+7j    1+5j    1+1j    1+3j  ... 
                         3-7j   3-5j   3-1j   3-3j   3+7j    3+5j    3+1j    3+3j  ... 
                         -9-7j  -9-5j  -9-1j  -9-3j  -9+7j   -9+5j   -9+1j   -9+3j  ... 
                        -11-7j -11-5j -11-1j -11-3j -11+7j  -11+5j  -11+1j  -11+3j  ... 
                         -1-9j -1-11j -7-9j  -7-11j  -1+9j  -1+11j   -7+9j  -7+11j  ... 
                         -3-9j -3-11j -5-9j  -5-11j  -3+9j  -3+11j   -5+9j  -5+11j  ... 
                          9-7j   9-5j  9-1j    9-3j   9+7j    9+5j    9+1j    9+3j  ... 
                         11-7j  11-5j 11-1j   11-3j  11+7j   11+5j   11+1j   11+3j  ... 
                          1-9j  1-11j  7-9j   7-11j   1+9j   1+11j    7+9j   7+11j  ... 
                          3-9j  3-11j  5-9j   5-11j   3+9j   3+11j    5+9j   5+11j]; 
                                 % the 128QAM constellation comes from
                                 % IEEE_2004_"Implementation Aspects of High-Speed Wireless LAN Systems"
    case '256QAM'
        cnstPattern = [             -15+15j -13+15j -9+15j -11+15j -1+15j -3+15j -7+15j -5+15j 15+15j 13+15j 9+15j 11+15j 1+15j 3+15j 7+15j 5+15j ... 
                                    -15+13j -13+13j -9+13j -11+13j -1+13j -3+13j -7+13j -5+13j 15+13j 13+13j 9+13j 11+13j 1+13j 3+13j 7+13j 5+13j ... 
                                    -15+ 9j -13+ 9j -9+ 9j -11+ 9j -1+ 9j -3+ 9j -7+ 9j -5+ 9j 15+ 9j 13+ 9j 9+ 9j 11+ 9j 1+ 9j 3+ 9j 7+ 9j 5+ 9j ... 
                                    -15+11j -13+11j -9+11j -11+11j -1+11j -3+11j -7+11j -5+11j 15+11j 13+11j 9+11j 11+11j 1+11j 3+11j 7+11j 5+11j ... 
                                    -15+01j -13+01j -9+01j -11+01j -1+01j -3+01j -7+01j -5+01j 15+01j 13+01j 9+01j 11+01j 1+01j 3+01j 7+01j 5+01j ... 
                                    -15+03j -13+03j -9+03j -11+03j -1+03j -3+03j -7+03j -5+03j 15+03j 13+03j 9+03j 11+03j 1+03j 3+03j 7+03j 5+03j ... 
                                    -15+07j -13+07j -9+07j -11+07j -1+07j -3+07j -7+07j -5+07j 15+07j 13+07j 9+07j 11+07j 1+07j 3+07j 7+07j 5+07j ... 
                                    -15+05j -13+05j -9+05j -11+05j -1+05j -3+05j -7+05j -5+05j 15+05j 13+05j 9+05j 11+05j 1+05j 3+05j 7+05j 5+05j ... 
                                    -15+(-15)*1i -13+(-15)*1i -9+(-15)*1i -11+(-15)*1i -1+(-15)*1i -3+(-15)*1i -7+(-15)*1i  -5+(-15)*1i 15+(-15)*1i 13+(-15)*1i 9+(-15)*1i  11+(-15)*1i 1+(-15)*1i 3+(-15)*1i 7+(-15)*1i 5+(-15)*1i  ... 
                                    -15+(-13)*1i -13+(-13)*1i -9+(-13)*1i -11+(-13)*1i -1+(-13)*1i -3+(-13)*1i -7+(-13)*1i  -5+(-13)*1i 15+(-13)*1i 13+(-13)*1i 9+(-13)*1i  11+(-13)*1i 1+(-13)*1i 3+(-13)*1i 7+(-13)*1i 5+(-13)*1i ... 
                                     -15+(-9)*1i  -13+(-9)*1i  -9+(-9)*1i  -11+(-9)*1i  -1+(-9)*1i  -3+(-9)*1i  -7+(-9)*1i   -5+(-9)*1i  15+(-9)*1i  13+(-9)*1i  9+(-9)*1i   11+(-9)*1i  1+(-9)*1i  3+(-9)*1i  7+(-9)*1i  5+(-9)*1i ... 
                                    -15+(-11)*1i -13+(-11)*1i -9+(-11)*1i -11+(-11)*1i -1+(-11)*1i -3+(-11)*1i -7+(-11)*1i  -5+(-11)*1i 15+(-11)*1i 13+(-11)*1i 9+(-11)*1i  11+(-11)*1i 1+(-11)*1i 3+(-11)*1i 7+(-11)*1i 5+(-11)*1i ... 
                                     -15+(-1)*1i  -13+(-1)*1i  -9+(-1)*1i  -11+(-1)*1i  -1+(-1)*1i  -3+(-1)*1i  -7+(-1)*1i   -5+(-1)*1i  15+(-1)*1i  13+(-1)*1i  9+(-1)*1i   11+(-1)*1i  1+(-1)*1i  3+(-1)*1i  7+(-1)*1i  5+(-1)*1i ... 
                                     -15+(-3)*1i  -13+(-3)*1i  -9+(-3)*1i  -11+(-3)*1i  -1+(-3)*1i  -3+(-3)*1i  -7+(-3)*1i   -5+(-3)*1i  15+(-3)*1i  13+(-3)*1i  9+(-3)*1i   11+(-3)*1i  1+(-3)*1i  3+(-3)*1i  7+(-3)*1i  5+(-3)*1i ... 
                                     -15+(-7)*1i  -13+(-7)*1i  -9+(-7)*1i  -11+(-7)*1i  -1+(-7)*1i  -3+(-7)*1i  -7+(-7)*1i   -5+(-7)*1i  15+(-7)*1i  13+(-7)*1i  9+(-7)*1i   11+(-7)*1i  1+(-7)*1i  3+(-7)*1i  7+(-7)*1i  5+(-7)*1i ... 
                                     -15+(-5)*1i  -13+(-5)*1i  -9+(-5)*1i  -11+(-5)*1i  -1+(-5)*1i  -3+(-5)*1i  -7+(-5)*1i   -5+(-5)*1i  15+(-5)*1i  13+(-5)*1i  9+(-5)*1i   11+(-5)*1i  1+(-5)*1i  3+(-5)*1i  7+(-5)*1i  5+(-5)*1i]; 
                                % IEEE_2003_08__"IEEE P802.15 Wireless Personal Area
                                % Networks"
    otherwise
        error('Un-supported modulation format');
end

for idx = 1:2^nBpB
   qamSyms( abs(qamSig-cnstPattern(idx))<eps ) = idx-1;
end

bitsMatrix    = de2bi(qamSyms,'left-msb').';
bits          = bitsMatrix(:);

end